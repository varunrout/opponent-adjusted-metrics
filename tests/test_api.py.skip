"""Test API endpoints."""

import pytest
from fastapi.testclient import TestClient


@pytest.fixture
def client():
    """Create test client."""
    from opponent_adjusted.api.service import app
    return TestClient(app)


def test_health_check(client):
    """Test health check endpoint."""
    response = client.get("/health")
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "healthy"
    assert "version" in data


def test_get_model_version_not_found(client):
    """Test model version endpoint when no model exists."""
    response = client.get("/models/cxg/version")
    # Should return 404 when no model is trained yet
    assert response.status_code == 404


def test_predict_cxg_not_implemented(client):
    """Test prediction endpoint (not implemented without trained model)."""
    payload = {
        "location_x": 108.0,
        "location_y": 40.0,
        "body_part": "Right Foot",
        "technique": "Normal",
        "shot_type": "Open Play",
        "first_time": False,
        "minute": 45,
        "score_diff": 0,
        "under_pressure": False,
        "opponent_team_id": 1,
    }
    response = client.post("/predict/cxg", json=payload)
    # Should return 501 (not implemented) without trained model
    assert response.status_code == 501


def test_get_player_aggregates_not_found(client):
    """Test player aggregates endpoint when no data exists."""
    response = client.get("/aggregates/player?model=cxg_v1&limit=10")
    # Should return 404 when model doesn't exist
    assert response.status_code == 404


def test_get_team_aggregates_not_found(client):
    """Test team aggregates endpoint when no data exists."""
    response = client.get("/aggregates/team?model=cxg_v1&limit=10")
    # Should return 404 when model doesn't exist
    assert response.status_code == 404
