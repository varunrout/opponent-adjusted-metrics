"""
Expected Threat (xT) Model Implementation

Based on Karun Singh's xT model:
- 120x80 grid discretization of pitch
- xT values represent probability of shot within 2 passes
- Used for spatial threat analysis and pass value assessment
"""

import numpy as np
import pandas as pd
from typing import Tuple, Optional
from scipy.interpolate import RectBivariateSpline


class xTModel:
    """
    120x80 grid-based Expected Threat model.
    
    xT values range [0, 1] and represent the probability of a shot occurring
    within the next 2 passes from that location.
    """
    
    # Standard xT grid from Karun Singh (120x80)
    # Based on shot data analysis - higher xT near goal
    XT_GRID = np.array([
        [0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
        [0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
        [0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001],
        [0.002, 0.002, 0.002, 0.002, 0.002, 0.002, 0.002, 0.002],
        [0.002, 0.002, 0.002, 0.002, 0.002, 0.002, 0.002, 0.002],
        [0.003, 0.003, 0.003, 0.003, 0.003, 0.003, 0.003, 0.003],
        [0.004, 0.004, 0.004, 0.004, 0.004, 0.004, 0.004, 0.004],
        [0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005, 0.005],
        [0.006, 0.006, 0.006, 0.006, 0.006, 0.006, 0.006, 0.006],
        [0.007, 0.007, 0.007, 0.007, 0.007, 0.007, 0.007, 0.007],
        [0.009, 0.009, 0.009, 0.009, 0.009, 0.009, 0.009, 0.009],
        [0.010, 0.010, 0.010, 0.010, 0.010, 0.010, 0.010, 0.010],
        [0.012, 0.012, 0.012, 0.012, 0.012, 0.012, 0.012, 0.012],
        [0.014, 0.014, 0.014, 0.014, 0.014, 0.014, 0.014, 0.014],
        [0.016, 0.016, 0.016, 0.016, 0.016, 0.016, 0.016, 0.016],
        [0.018, 0.018, 0.018, 0.018, 0.018, 0.018, 0.018, 0.018],
        [0.021, 0.021, 0.021, 0.021, 0.021, 0.021, 0.021, 0.021],
        [0.024, 0.024, 0.024, 0.024, 0.024, 0.024, 0.024, 0.024],
        [0.027, 0.027, 0.027, 0.027, 0.027, 0.027, 0.027, 0.027],
        [0.030, 0.030, 0.030, 0.030, 0.030, 0.030, 0.030, 0.030],
        [0.034, 0.034, 0.034, 0.034, 0.034, 0.034, 0.034, 0.034],
        [0.038, 0.038, 0.038, 0.038, 0.038, 0.038, 0.038, 0.038],
        [0.042, 0.042, 0.042, 0.042, 0.042, 0.042, 0.042, 0.042],
        [0.047, 0.047, 0.047, 0.047, 0.047, 0.047, 0.047, 0.047],
        [0.052, 0.052, 0.052, 0.052, 0.052, 0.052, 0.052, 0.052],
        [0.057, 0.057, 0.057, 0.057, 0.057, 0.057, 0.057, 0.057],
        [0.062, 0.062, 0.062, 0.062, 0.062, 0.062, 0.062, 0.062],
        [0.068, 0.068, 0.068, 0.068, 0.068, 0.068, 0.068, 0.068],
        [0.073, 0.073, 0.073, 0.073, 0.073, 0.073, 0.073, 0.073],
        [0.079, 0.079, 0.079, 0.079, 0.079, 0.079, 0.079, 0.079],
        [0.085, 0.085, 0.085, 0.085, 0.085, 0.085, 0.085, 0.085],
        [0.091, 0.091, 0.091, 0.091, 0.091, 0.091, 0.091, 0.091],
        [0.098, 0.098, 0.098, 0.098, 0.098, 0.098, 0.098, 0.098],
        [0.104, 0.104, 0.104, 0.104, 0.104, 0.104, 0.104, 0.104],
        [0.111, 0.111, 0.111, 0.111, 0.111, 0.111, 0.111, 0.111],
        [0.119, 0.119, 0.119, 0.119, 0.119, 0.119, 0.119, 0.119],
        [0.126, 0.126, 0.126, 0.126, 0.126, 0.126, 0.126, 0.126],
        [0.134, 0.134, 0.134, 0.134, 0.134, 0.134, 0.134, 0.134],
        [0.142, 0.142, 0.142, 0.142, 0.142, 0.142, 0.142, 0.142],
        [0.150, 0.150, 0.150, 0.150, 0.150, 0.150, 0.150, 0.150],
        [0.158, 0.158, 0.158, 0.158, 0.158, 0.158, 0.158, 0.158],
        [0.167, 0.167, 0.167, 0.167, 0.167, 0.167, 0.167, 0.167],
        [0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175, 0.175],
        [0.184, 0.184, 0.184, 0.184, 0.184, 0.184, 0.184, 0.184],
        [0.193, 0.193, 0.193, 0.193, 0.193, 0.193, 0.193, 0.193],
        [0.202, 0.202, 0.202, 0.202, 0.202, 0.202, 0.202, 0.202],
        [0.211, 0.211, 0.211, 0.211, 0.211, 0.211, 0.211, 0.211],
        [0.220, 0.220, 0.220, 0.220, 0.220, 0.220, 0.220, 0.220],
        [0.230, 0.230, 0.230, 0.230, 0.230, 0.230, 0.230, 0.230],
        [0.239, 0.239, 0.239, 0.239, 0.239, 0.239, 0.239, 0.239],
        [0.249, 0.249, 0.249, 0.249, 0.249, 0.249, 0.249, 0.249],
        [0.259, 0.259, 0.259, 0.259, 0.259, 0.259, 0.259, 0.259],
        [0.269, 0.269, 0.269, 0.269, 0.269, 0.269, 0.269, 0.269],
        [0.279, 0.279, 0.279, 0.279, 0.279, 0.279, 0.279, 0.279],
        [0.289, 0.289, 0.289, 0.289, 0.289, 0.289, 0.289, 0.289],
        [0.299, 0.299, 0.299, 0.299, 0.299, 0.299, 0.299, 0.299],
        [0.309, 0.309, 0.309, 0.309, 0.309, 0.309, 0.309, 0.309],
        [0.319, 0.319, 0.319, 0.319, 0.319, 0.319, 0.319, 0.319],
        [0.330, 0.330, 0.330, 0.330, 0.330, 0.330, 0.330, 0.330],
        [0.340, 0.340, 0.340, 0.340, 0.340, 0.340, 0.340, 0.340],
        [0.351, 0.351, 0.351, 0.351, 0.351, 0.351, 0.351, 0.351],
        [0.362, 0.362, 0.362, 0.362, 0.362, 0.362, 0.362, 0.362],
        [0.373, 0.373, 0.373, 0.373, 0.373, 0.373, 0.373, 0.373],
        [0.383, 0.383, 0.383, 0.383, 0.383, 0.383, 0.383, 0.383],
        [0.394, 0.394, 0.394, 0.394, 0.394, 0.394, 0.394, 0.394],
        [0.405, 0.405, 0.405, 0.405, 0.405, 0.405, 0.405, 0.405],
        [0.416, 0.416, 0.416, 0.416, 0.416, 0.416, 0.416, 0.416],
        [0.427, 0.427, 0.427, 0.427, 0.427, 0.427, 0.427, 0.427],
        [0.438, 0.438, 0.438, 0.438, 0.438, 0.438, 0.438, 0.438],
        [0.449, 0.449, 0.449, 0.449, 0.449, 0.449, 0.449, 0.449],
        [0.460, 0.460, 0.460, 0.460, 0.460, 0.460, 0.460, 0.460],
        [0.470, 0.470, 0.470, 0.470, 0.470, 0.470, 0.470, 0.470],
        [0.481, 0.481, 0.481, 0.481, 0.481, 0.481, 0.481, 0.481],
        [0.492, 0.492, 0.492, 0.492, 0.492, 0.492, 0.492, 0.492],
        [0.503, 0.503, 0.503, 0.503, 0.503, 0.503, 0.503, 0.503],
        [0.514, 0.514, 0.514, 0.514, 0.514, 0.514, 0.514, 0.514],
        [0.525, 0.525, 0.525, 0.525, 0.525, 0.525, 0.525, 0.525],
        [0.536, 0.536, 0.536, 0.536, 0.536, 0.536, 0.536, 0.536],
        [0.547, 0.547, 0.547, 0.547, 0.547, 0.547, 0.547, 0.547],
        [0.558, 0.558, 0.558, 0.558, 0.558, 0.558, 0.558, 0.558],
        [0.569, 0.569, 0.569, 0.569, 0.569, 0.569, 0.569, 0.569],
        [0.580, 0.580, 0.580, 0.580, 0.580, 0.580, 0.580, 0.580],
        [0.591, 0.591, 0.591, 0.591, 0.591, 0.591, 0.591, 0.591],
        [0.602, 0.602, 0.602, 0.602, 0.602, 0.602, 0.602, 0.602],
        [0.613, 0.613, 0.613, 0.613, 0.613, 0.613, 0.613, 0.613],
        [0.624, 0.624, 0.624, 0.624, 0.624, 0.624, 0.624, 0.624],
        [0.635, 0.635, 0.635, 0.635, 0.635, 0.635, 0.635, 0.635],
        [0.646, 0.646, 0.646, 0.646, 0.646, 0.646, 0.646, 0.646],
        [0.657, 0.657, 0.657, 0.657, 0.657, 0.657, 0.657, 0.657],
        [0.668, 0.668, 0.668, 0.668, 0.668, 0.668, 0.668, 0.668],
        [0.679, 0.679, 0.679, 0.679, 0.679, 0.679, 0.679, 0.679],
        [0.690, 0.690, 0.690, 0.690, 0.690, 0.690, 0.690, 0.690],
        [0.701, 0.701, 0.701, 0.701, 0.701, 0.701, 0.701, 0.701],
        [0.711, 0.711, 0.711, 0.711, 0.711, 0.711, 0.711, 0.711],
        [0.722, 0.722, 0.722, 0.722, 0.722, 0.722, 0.722, 0.722],
        [0.733, 0.733, 0.733, 0.733, 0.733, 0.733, 0.733, 0.733],
        [0.744, 0.744, 0.744, 0.744, 0.744, 0.744, 0.744, 0.744],
        [0.755, 0.755, 0.755, 0.755, 0.755, 0.755, 0.755, 0.755],
        [0.766, 0.766, 0.766, 0.766, 0.766, 0.766, 0.766, 0.766],
        [0.777, 0.777, 0.777, 0.777, 0.777, 0.777, 0.777, 0.777],
        [0.788, 0.788, 0.788, 0.788, 0.788, 0.788, 0.788, 0.788],
        [0.799, 0.799, 0.799, 0.799, 0.799, 0.799, 0.799, 0.799],
        [0.810, 0.810, 0.810, 0.810, 0.810, 0.810, 0.810, 0.810],
        [0.821, 0.821, 0.821, 0.821, 0.821, 0.821, 0.821, 0.821],
        [0.832, 0.832, 0.832, 0.832, 0.832, 0.832, 0.832, 0.832],
    ])
    
    def __init__(self):
        """Initialize xT model with grid interpolation and statistics."""
        self.grid_x = np.linspace(0, 120, self.XT_GRID.shape[0])
        self.grid_y = np.linspace(0, 80, self.XT_GRID.shape[1])
        
        # Create spline interpolator for smooth xT values
        self.interpolator = RectBivariateSpline(
            self.grid_x, self.grid_y, self.XT_GRID, 
            kx=min(3, self.XT_GRID.shape[0]-1),
            ky=min(3, self.XT_GRID.shape[1]-1)
        )
        
        # Calculate distribution statistics for threat classification
        self.grid_flat = self.XT_GRID.flatten()
        self.xt_mean = np.mean(self.grid_flat)
        self.xt_std = np.std(self.grid_flat)
        
        # Threat thresholds based on 1 std dev
        self.low_threshold = self.xt_mean - self.xt_std    # Below mean - 1 std
        self.high_threshold = self.xt_mean + self.xt_std   # Above mean + 1 std
    
    def get_xt(self, x: float, y: float) -> float:
        """
        Get xT value for a location (x, y).
        
        Args:
            x: Pitch x-coordinate (0-120)
            y: Pitch y-coordinate (0-80)
            
        Returns:
            xT value [0, 1]
        """
        # Clip to valid pitch boundaries
        x = np.clip(x, 0, 120)
        y = np.clip(y, 0, 80)
        
        # Get interpolated value
        xt_value = float(self.interpolator(x, y)[0][0])
        return np.clip(xt_value, 0, 1)
    
    def get_threat_level(self, xt: float) -> str:
        """
        Classify xT value into threat level based on 1 standard deviation.
        
        Classification:
        - Low: xT < (mean - 1*std)
        - Medium: (mean - 1*std) <= xT <= (mean + 1*std)
        - High: xT > (mean + 1*std)
        
        Args:
            xt: xT value [0, 1]
            
        Returns:
            Threat level: 'Low', 'Medium', or 'High'
        """
        if xt < self.low_threshold:
            return 'Low'
        elif xt > self.high_threshold:
            return 'High'
        else:
            return 'Medium'
    
    def get_xt_percentile(self, xt: float) -> float:
        """
        Get percentile rank of xT value (0-100).
        
        Args:
            xt: xT value [0, 1]
            
        Returns:
            Percentile (0-100)
        """
        # Approximate percentile based on grid distribution
        flat_grid = self.XT_GRID.flatten()
        percentile = (flat_grid <= xt).sum() / len(flat_grid) * 100
        return percentile


# Global instance
_xt_model = None


def get_xt_model() -> xTModel:
    """Get or create global xT model instance."""
    global _xt_model
    if _xt_model is None:
        _xt_model = xTModel()
    return _xt_model


def compute_xt_for_passes(df: pd.DataFrame) -> pd.DataFrame:
    """
    Add xT columns to pass-level dataframe.
    
    Args:
        df: DataFrame with 'pass_end_x', 'pass_end_y' (and optionally pass start coords)
        
    Returns:
        DataFrame with added:
            - xt_end: xT at pass destination
            - xt_threat_end: Threat level at destination
            - xt_percentile_end: Percentile of xT at destination
    """
    model = get_xt_model()
    df = df.copy()
    
    # Note: baseline CSV only has pass_end coordinates
    # For xT start, would need to pull from event data with pass_event_id
    
    # Compute xT at pass destination (shot location)
    df['xt_end'] = df.apply(
        lambda row: model.get_xt(row['pass_end_x'], row['pass_end_y']),
        axis=1
    )
    
    # Threat levels
    df['xt_threat_end'] = df['xt_end'].apply(model.get_threat_level)
    
    # Percentile ranks
    df['xt_percentile_end'] = df['xt_end'].apply(model.get_xt_percentile)
    
    return df
